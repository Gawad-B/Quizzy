<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Gain - Analysis</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3976/3976625.png">
    <link href="/static/base.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Attribution: Graduation cap icons created by Sir.Vector - Flaticon -->
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <i data-lucide="graduation-cap" class="w-8 h-8"></i>
                </div>
                <h1>Quizzy</h1>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <p class="nav-title">Menu</p>
                    <a href="/home" class="nav-link" data-page="home">
                        <i data-lucide="home"></i> Home
                    </a>
                </div>
                <div class="nav-section">
                    <p class="nav-title">Quiz</p>
                    <a href="/createQuiz" class="nav-link" data-page="createQuiz">
                        <i data-lucide="plus-circle"></i> Create Quiz
                    </a>
                    <a href="#" class="nav-link">
                        <i data-lucide="history"></i> Previous Quizzes
                    </a>
                </div>
                <div class="nav-section">
                    <p class="nav-title">Performance</p>
                    <a href="/overview" class="nav-link" data-page="overview">
                        <i data-lucide="layout-dashboard"></i> Overview
                    </a>
                    <a href="/analysis" class="nav-link" data-page="analysis">
                        <i data-lucide="bar-chart-3"></i> Analysis
                    </a>
                </div>
                <div class="nav-section">
                    <p class="nav-title">Auth</p>
                    <a href="{{ url_for('logout') }}" class="nav-link">
                        <i data-lucide="log-out"></i> Logout
                    </a>
                </div>
                <div class="nav-section"><p class="nav-title">Help</p><a href="#" class="nav-link"><div class="nav-link-content"><i data-lucide="instagram"></i> Social Links</div> <i data-lucide="external-link" style="width:16px; height:16px;"></i></a><a href="#" class="nav-link"><div class="nav-link-content"><i data-lucide="message-square"></i> Contact Us</div> <i data-lucide="external-link" style="width:16px; height:16px;"></i></a></div>
            </nav>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button id="menu-toggle" class="menu-toggle">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <h2 class="header-title">Analysis</h2>
                </div>
                <div class="header-right">
                        <div class="notification-bell" id="notification-bell">
                        <i data-lucide="bell"></i>
                        <span class="notification-dot" id="notification-dot">
                            <span class="notification-dot-ping"></span>
                            <span class="notification-dot-inner"></span>
                        </span>
                        <!-- Notification Dropdown -->
                        <div class="notification-dropdown" id="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read" id="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list" id="notification-list">
                                <!-- Sample notifications -->
                                <div class="notification-item unread">
                                    <div class="notification-icon">
                                        <i data-lucide="check-circle"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p class="notification-title">Quiz Completed</p>
                                        <p class="notification-text">You scored 85% on Mathematics Quiz</p>
                                        <p class="notification-time">2 hours ago</p>
                                    </div>
                                </div>
                                <div class="notification-item unread">
                                    <div class="notification-icon">
                                        <i data-lucide="trophy"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p class="notification-title">Achievement Unlocked</p>
                                        <p class="notification-text">You've completed 10 quizzes this week!</p>
                                        <p class="notification-time">5 hours ago</p>
                                    </div>
                                </div>
                                <div class="notification-item">
                                    <div class="notification-icon">
                                        <i data-lucide="bell"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p class="notification-title">New Quiz Available</p>
                                        <p class="notification-text">Physics Chapter 3 quiz is now available</p>
                                        <p class="notification-time">1 day ago</p>
                                    </div>
                                </div>
                            </div>
                            <div class="notification-footer">
                                <a href="#" class="view-all-notifications">View all notifications</a>
                            </div>
                        </div>
                    </div>
                    <a href="/profile" class="user-profile" data-page="profile" style="text-decoration: none; color: inherit; cursor: pointer;">
                        {% if user and user['profile_image'] %}
                            <img src="{{ user['profile_image'] }}" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <img src="https://placehold.co/40x40/3498db/ffffff?text={{ session.get('user_name', 'User')[0] }}{{ session.get('user_name', 'User').split()[1][0] if session.get('user_name', 'User').split()|length > 1 else '' }}" alt="User Avatar">
                        {% endif %}
                        <div>
                            <p class="user-profile-name">{{ session.get('user_name', 'User') }}</p>
                            <p class="user-profile-role">Student</p>
                        </div>
                    </a>
                </div>
            </header>

            <!-- Main Content from templates -->
            <main id="dynamic-content" class="main-content">
                <!-- Content will be loaded here dynamically -->
            </main>
        </div>
    </div>
    
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <script>
        lucide.createIcons();

        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const notificationBell = document.getElementById('notification-bell');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationDot = document.getElementById('notification-dot');
        const markAllReadBtn = document.getElementById('mark-all-read');

        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-open');
            sidebarOverlay.classList.toggle('visible');
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', toggleSidebar);
        }
        if(sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        // Notification bell functionality
        if (notificationBell) {
            notificationBell.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.classList.toggle('show');
                lucide.createIcons();
            });
        }

        // Mark all as read functionality
        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const unreadItems = document.querySelectorAll('.notification-item.unread');
                unreadItems.forEach(item => {
                    item.classList.remove('unread');
                });
                // Hide notification dot
                if (notificationDot) {
                    notificationDot.style.display = 'none';
                }
            });
        }

        // Close notification dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (notificationDropdown && !notificationBell.contains(e.target)) {
                notificationDropdown.classList.remove('show');
            }
        });

        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                
                // Check if this link should load content dynamically
                if (link.hasAttribute('data-page')) {
                    e.preventDefault(); // Prevent default navigation
                    
                    const url = link.getAttribute('href');
                    const pageName = link.getAttribute('data-page');
                    
                    // Load content dynamically
                    loadPage(url, pageName, link);
                }
                
                // Don't do anything for disabled links
                if (link.classList.contains('disabled')) {
                    return;
                }
                
                // Remove active class from all links
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                
                // Add active class to the clicked link
                link.classList.add('active');
            });
        });

        // Handle user profile click
        const userProfile = document.querySelector('.user-profile');
        if (userProfile && userProfile.hasAttribute('data-page')) {
            userProfile.addEventListener('click', (e) => {
                e.preventDefault();
                
                const url = userProfile.getAttribute('href');
                const pageName = userProfile.getAttribute('data-page');
                
                // Remove active class from all nav links
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                
                // Load profile page
                loadPage(url, pageName, userProfile);
            });
        }

        // Function to load page content dynamically
        function loadPage(url, pageName, linkElement) {
            const contentArea = document.getElementById('dynamic-content');
            const headerTitle = document.querySelector('.header-title');
            
            // Show loading state
            contentArea.innerHTML = '<div style="text-align: center; padding: 3rem;"><p>Loading...</p></div>';
            
            // Fetch content via AJAX
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                // Update content area
                contentArea.innerHTML = html;
                
                // Update header title
                const pageTitle = pageName.charAt(0).toUpperCase() + pageName.slice(1);
                if (headerTitle) {
                    headerTitle.textContent = pageTitle.replace(/([A-Z])/g, ' $1').trim();
                }
                
                // Reinitialize Lucide icons for the new content
                lucide.createIcons();
                
                // Close sidebar on mobile after navigation
                if (sidebar.classList.contains('sidebar-open')) {
                    toggleSidebar();
                }
                
                // Re-run any page-specific scripts
                initializePageScripts();
            })
            .catch(error => {
                console.error('Error loading page:', error);
                contentArea.innerHTML = '<div style="text-align: center; padding: 3rem; color: #ef4444;"><p>Error loading content. Please try again.</p></div>';
            });
        }

        // Function to initialize page-specific scripts
        function initializePageScripts() {
            // Subject card selection
            const subjectCards = document.querySelectorAll('.subject-card');
            subjectCards.forEach(card => {
                card.addEventListener('click', () => {
                    card.classList.toggle('selected');
                });
            });
            
            // Accordion for form sections
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach((section) => {
                const header = section.querySelector('.form-section-header');
                section.classList.add('open');
                
                if (header) {
                    header.addEventListener('click', () => {
                        section.classList.toggle('open');
                    });
                }
            });

            // Card filters
            const cardFilters = document.querySelectorAll('.card-filters');
            cardFilters.forEach(filterGroup => {
                const buttons = filterGroup.querySelectorAll('.card-filter-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        buttons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    });
                });
            });

            // Profile form submission
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                const saveBtn = document.getElementById('save-btn');
                const formInputs = profileForm.querySelectorAll('input, select, textarea');
                
                // Store original values
                const originalValues = {};
                formInputs.forEach(input => {
                    originalValues[input.name || input.id] = input.value;
                });
                
                // Detect form changes
                formInputs.forEach(input => {
                    input.addEventListener('input', function() {
                        let hasChanges = false;
                        formInputs.forEach(inp => {
                            if (inp.value !== originalValues[inp.name || inp.id]) {
                                hasChanges = true;
                            }
                        });
                        
                        if (hasChanges) {
                            saveBtn.disabled = false;
                            saveBtn.classList.add('active');
                            saveBtn.style.opacity = '1';
                            saveBtn.style.cursor = 'pointer';
                        } else {
                            saveBtn.disabled = true;
                            saveBtn.classList.remove('active');
                            saveBtn.style.opacity = '0.5';
                            saveBtn.style.cursor = 'not-allowed';
                        }
                    });
                });
                
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    
                    // Add saving animation
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                    saveBtn.classList.add('saving');
                    
                    // Submit form via fetch
                    fetch('/update_profile', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.message || 'Server error');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Show success message
                            alert(data.message);
                            
                            // Update original values
                            formInputs.forEach(input => {
                                originalValues[input.name || input.id] = input.value;
                            });
                            
                            // Reset button state
                            saveBtn.classList.remove('saving', 'active');
                            saveBtn.textContent = 'Save';
                            saveBtn.disabled = true;
                            saveBtn.style.opacity = '0.5';
                            saveBtn.style.cursor = 'not-allowed';
                            
                            // Reload the profile page to show updated data
                            loadPage('/profile', 'profile', null);
                        } else {
                            // Show error message
                            alert(data.message);
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Save';
                            saveBtn.classList.remove('saving');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save';
                        saveBtn.classList.remove('saving');
                        alert('Error: ' + error.message);
                    });
                });
            }
            
            // Profile image upload handler
            const changeImageBtn = document.getElementById('change-image-btn');
            const imageInput = document.getElementById('profile-image-input');
            const profileAvatar = document.getElementById('profile-avatar');
            
            if (changeImageBtn && imageInput) {
                // Trigger file input when button is clicked
                changeImageBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    imageInput.click();
                });
                
                // Handle file selection
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file type
                        if (!file.type.startsWith('image/')) {
                            alert('Please select an image file');
                            return;
                        }
                        
                        // Validate file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Image size should be less than 5MB');
                            return;
                        }
                        
                        // Preview image
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            profileAvatar.innerHTML = `<img src="${e.target.result}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                            lucide.createIcons();
                        };
                        reader.readAsDataURL(file);
                        
                        // Upload image
                        uploadProfileImage(file);
                    }
                });
            }
        }
        
        // Function to upload profile image
        function uploadProfileImage(file) {
            const formData = new FormData();
            formData.append('profile_image', file);
            
            // Show uploading status
            const changeImageBtn = document.getElementById('change-image-btn');
            const originalText = changeImageBtn.textContent;
            changeImageBtn.textContent = 'Uploading...';
            changeImageBtn.disabled = true;
            
            fetch('/upload_profile_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile image updated successfully!');
                    // Reload the entire page to update the header
                    window.location.reload();
                } else {
                    alert('Error uploading image: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading image. Please try again.');
            })
            .finally(() => {
                changeImageBtn.textContent = originalText;
                changeImageBtn.disabled = false;
            });
        }

        // Load home page by default
        window.addEventListener('DOMContentLoaded', () => {
            const homeLink = document.querySelector('a[data-page="home"]');
            if (homeLink) {
                // Set home link as active
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                homeLink.classList.add('active');
                
                // Load home content
                loadPage('/home', 'home', homeLink);
            }
        });
    </script>
</body>
</html>

